version: "3.9"

services:
  postgres:
    image: postgres:14
    environment:
      POSTGRES_USER: portatou
      POSTGRES_PASSWORD: portatou
      POSTGRES_DB: portatou
    ports:
      - "5432:5432"
    volumes: [ "pgdata:/var/lib/postgresql/data" ]

  redis:
    image: redis:7
    ports: [ "6379:6379" ]

  minio:
    image: minio/minio:latest
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes: [ "miniodata:/data" ]

  n8n:
    image: n8nio/n8n:latest
    restart: always
    ports: [ "5678:5678" ]
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: portatou
      DB_POSTGRESDB_USER: portatou
      DB_POSTGRESDB_PASSWORD: portatou
      # Auth UI n8n
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: admin
      N8N_BASIC_AUTH_PASSWORD: admin123
      # Chiffrement interne
      N8N_ENCRYPTION_KEY: "__REPLACE_WITH_RANDOM__"
      # Fuseau horaire
      GENERIC_TIMEZONE: Europe/Paris
    depends_on: [ postgres, redis, minio ]
    volumes: [ "n8n_data:/home/node/.n8n" ]

  influxdb:
    image: influxdb:2
    ports: [ "8086:8086" ]
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: influx
      DOCKER_INFLUXDB_INIT_PASSWORD: influx123
      DOCKER_INFLUXDB_INIT_ORG: portatou
      DOCKER_INFLUXDB_INIT_BUCKET: portatou
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: influxtoken

  grafana:
    image: grafana/grafana:latest
    ports: [ "3000:3000" ]
    depends_on: [ influxdb ]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: grafana

volumes:
  pgdata:
  miniodata:
  n8n_data:
